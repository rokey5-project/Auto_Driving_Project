<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>FireGuard Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        body { background:#111; color:#eee; overflow:hidden; }
        .left-panel { background:#1d1d1d; height:100vh; padding:20px; overflow-y:auto; }
        .center-panel { background:#000; height:100vh; padding:0 !important; overflow:hidden; }
        .right-panel { background:#1d1d1d; height:100vh; padding:20px; overflow-y:auto; }

        .grid-4cams {
            display:grid;
            grid-template-columns:1fr 1fr;
            grid-template-rows:1fr 1fr;
            width:100%; height:100%;
        }
        .grid-item { border:1px solid #333; }
        .grid-item img { width:100%; height:100%; object-fit:cover; }

        .cam-box { width:100%; height:100%; object-fit:cover; }

        .mini-monitor-box {
            width:100%; height:200px;
            border:1px solid #444;
            background:#000;
            overflow:hidden;
            margin-top:15px;
            margin-bottom:15px;
        }
        .mini-monitor-box img {
            width:100%; height:100%;
            object-fit:contain;
        }

        #slamCanvas {
            width:100% !important;
            height:100% !important;
            display:block;
            background:#000;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <div class="row">

        <!-- ================= LEFT ================= -->
        <div class="col-3 left-panel">

            <h3 class="mb-4">ìƒíƒœ íŒ¨ë„</h3>

            <div>ğŸ”¥ í™”ì¬ ê°ì§€ ìƒíƒœ:</div>
            {% if fire_detected %}
                <div style="color:red">ğŸš¨ í™”ì¬ ë°œìƒ ğŸš¨</div>
            {% else %}
                <div style="color:lime">í™”ì¬ ë¯¸ê°ì§€</div>
            {% endif %}

            <hr>
            <div>ğŸ¤– ì¶œë™ ë¡œë´‡:</div>

            {% for r in active_robots %}
            <div style="margin-bottom:10px;">
                <strong>ID:</strong> {{ r.id }} / <strong>ì¢…ë¥˜:</strong> {{ r.type }}<br>

                <strong>ìƒíƒœ:</strong>
                {% if r.connected %}
                    <span style="color:lime;">Connected</span>
                {% else %}
                    <span style="color:gray;">Disconnected</span>
                {% endif %}
                <br>

                <strong>ì¹´ë©”ë¼:</strong>
                {% if r.camera_ok %}
                    <span style="color:cyan;">OK</span>
                {% else %}
                    <span style="color:gray;">No Signal</span>
                {% endif %}
                <br>

                <strong>ë°°í„°ë¦¬:</strong>
                {% if r.battery != "N/A" %}
                    <span style="color:cyan;">{{ r.battery }}</span>
                {% else %}
                    <span style="color:gray;">N/A</span>
                {% endif %}
            </div>
            {% endfor %}

            <hr>

            <!-- ì „ë°© ì¥ì• ë¬¼ ìµœì†Œ ê±°ë¦¬ -->
            <div style="margin-bottom:8px;"><strong>ğŸ“ ì „ë°© ì¥ì• ë¬¼ ìµœì†Œ ê±°ë¦¬</strong></div>

            <div style="margin-bottom:5px;">
                <strong>TB4A :</strong>
                <span id="depthA" style="color:cyan;">
                    {% if depth_A is not none and depth_A != 'N/A' %}{{ depth_A }} m{% else %}N/A{% endif %}
                </span>
            </div>

            <div style="margin-bottom:10px;">
                <strong>TB4B :</strong>
                <span id="depthB" style="color:cyan;">
                    {% if depth_B is not none and depth_B != 'N/A' %}{{ depth_B }} m{% else %}N/A{% endif %}
                </span>
            </div>

            <button class="btn btn-info w-100" onclick="switchView('logs')">ë¡œê·¸ ì¡°íšŒ</button>
        </div>

        <!-- ================= CENTER ================= -->
        <div class="col-6 center-panel">

            {% if current_view == "zoom" %}
                {% if zoom_target == "robot4" %}
                    <img class="cam-box" src="/video_feed/robot4">
                {% elif zoom_target == "robot6" %}
                    <img class="cam-box" src="/video_feed/robot6">
                {% elif zoom_target == "cam1" %}
                    <img class="cam-box" src="/cam_feed/1">
                {% elif zoom_target == "cam2" %}
                    <img class="cam-box" src="/cam_feed/2">
                {% endif %}

            {% elif current_view == "multi" %}
                <div class="grid-4cams">
                    <div class="grid-item"><img src="/video_feed/robot4"></div>
                    <div class="grid-item"><img src="/video_feed/robot6"></div>
                    <div class="grid-item"><img src="/cam_feed/1"></div>
                    <div class="grid-item"><img src="/cam_feed/2"></div>
                </div>

            {% elif current_view == "slam" %}
                <canvas id="slamCanvas" width="900" height="900"></canvas>

            {% elif current_view == "logs" %}
                <h3 class="mb-4">í™”ì¬ ê°ì§€ ë¡œê·¸</h3>
                <table class="table table-bordered table-striped">
                    <thead><tr><th>Topic</th><th>Message</th><th>Timestamp</th></tr></thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            <td>{{ row.topic }}</td>
                            <td>{{ row.message }}</td>
                            <td>{{ row.detect_time }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>

        <!-- ================= RIGHT ================= -->
        <div class="col-3 right-panel">

            <h3 class="mb-4">í™”ë©´ ì „í™˜</h3>

            <button class="btn btn-secondary w-100 mb-2" onclick="zoomView('robot4')">TB4A í™•ëŒ€</button>
            <button class="btn btn-secondary w-100 mb-2" onclick="zoomView('robot6')">TB4B í™•ëŒ€</button>
            <button class="btn btn-secondary w-100 mb-2" onclick="zoomView('cam1')">CAM1 í™•ëŒ€</button>
            <button class="btn btn-secondary w-100 mb-2" onclick="zoomView('cam2')">CAM2 í™•ëŒ€</button>

            <button class="btn btn-warning w-100 mb-3" onclick="unzoom()">4ë¶„í•  ë³µê·€</button>

            <hr>
            <button class="btn btn-secondary w-100 mb-2" onclick="switchView('slam')">SLAM MAP</button>

            <div class="mini-monitor-box">
                <img id="miniSlam" src="/slam_overlay">
            </div>

            <hr>
            <a href="/logout" class="btn btn-danger w-100 mb-3">ë¡œê·¸ì•„ì›ƒ</a>

            <!-- ë¡œë´‡ ë¯¸ì…˜ ë¡œê·¸ -->
            <h5 class="mb-2">ğŸ§­ ë¡œë´‡ ì¶œë™ ë¡œê·¸</h5>

            <button class="btn btn-outline-info w-100 mb-2"
                    onclick="document.getElementById('missionBox').classList.toggle('d-none')">
                ì¶œë™/ë³µê·€ ê¸°ë¡ ë³´ê¸°
            </button>

            <div id="missionBox" class="d-none" style="font-size:13px;">
                <table class="table table-dark table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Robot</th>
                            <th>ì¶œë°œ</th>
                            <th>ë„ì°©</th>
                            <th>ìƒíƒœ</th>
                            <th>ì†Œìš”</th>
                        </tr>
                    </thead>

                    <tbody>
                    {% if mission_rows and mission_rows|length > 0 %}
                        {% for m in mission_rows %}
                        <tr>
                            <td>{{ m.robot_id }}</td>
                            <td>{{ m.start_time }}</td>
                            <td>{% if m.end_time is not none %}{{ m.end_time }}{% else %}-{% endif %}</td>
                            <td>
                                {% if m.status == 'running' %}
                                    <span style="color:orange;">119ì‹ ê³ ì™„ë£Œ</span>
                                {% elif m.status == 'done' %}
                                    <span style="color:lime;">ì™„ë£Œ</span>
                                {% else %}
                                    <span style="color:gray;">UNKNOWN</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if m.duration is not none %}
                                    {{ (m.duration // 60)|int }}:{{ "%02d"|format((m.duration % 60)|int) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="5" style="text-align:center; color:gray;">âš  ë¡œê·¸ ì—†ìŒ</td></tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</div>

<script>
function switchView(mode) {
    fetch(`/change_main_view?mode=${mode}`).then(() =>
        setTimeout(() => location.reload(), 100)
    );
}
function zoomView(target) {
    fetch(`/zoom?target=${target}`).then(() =>
        setTimeout(() => location.reload(), 100)
    );
}
function unzoom() {
    fetch("/unzoom").then(() =>
        setTimeout(() => location.reload(), 100)
    );
}

/* ë¯¸ë‹ˆ SLAM ìë™ ê°±ì‹  */
setInterval(() => {
    const img = document.getElementById("miniSlam");
    if (img) img.src = "/slam_overlay?t=" + new Date().getTime();
}, 1000);

/* ì¤‘ì•™ SLAM ìº”ë²„ìŠ¤ ìë™ ê°±ì‹  */
const canvas = document.getElementById("slamCanvas");
if (canvas) {
    const ctx = canvas.getContext("2d");
    const slamImg = new Image();

    setInterval(() => {
        slamImg.src = "/slam_overlay?t=" + new Date().getTime();
    }, 1000);

    slamImg.onload = () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(slamImg, 0, 0, canvas.width, canvas.height);
    };
}

/* ì „ë°© ê±°ë¦¬ ì‹¤ì‹œê°„ ê°±ì‹  */
setInterval(() => {
    fetch('/api/realtime/robot_state')
        .then(res => res.json())
        .then(data => {

            const a = data.robot4?.depth;
            const b = data.robot6?.depth;

            const elA = document.getElementById("depthA");
            const elB = document.getElementById("depthB");

            if (elA) {
                if (a !== null && a !== undefined) {
                    elA.innerText = Number(a).toFixed(2) + " m";
                } else {
                    elA.innerText = "N/A";
                }
            }

            if (elB) {
                if (b !== null && b !== undefined) {
                    elB.innerText = Number(b).toFixed(2) + " m";
                } else {
                    elB.innerText = "N/A";
                }
            }
        });
}, 1000);
</script>

</body>
</html>
